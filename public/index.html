<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotingfy Game</title>
    <script
      src="https://unpkg.com/htmx.org@1.9.10"
      integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container">
      <main>
        <section id="top-songs-section">
          <h2>Your Top Songs</h2>
          <button id="load-top-songs" class="btn-primary">
            Load Top Songs
          </button>
          <div id="top-songs-container"></div>
        </section>
      </main>

      <footer>
        <p>Made with <span class="heart">♥</span></p>
      </footer>
    </div>

    <script>
      async function fetchTopSongs(accessToken) {
        const container = document.getElementById("top-songs-container");
        const loadButton = document.getElementById("load-top-songs");

        // Show loading state
        container.innerHTML =
          '<p class="loading">Loading your top songs...</p>';
        loadButton.disabled = true;

        try {
          const response = await fetch(`/api/top-songs?token=${accessToken}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to fetch top songs");
          }

          displayTopSongs(data.topSongs);
        } catch (error) {
          container.innerHTML = `
                        <div class="error">
                            <p>❌ ${error.message}</p>
                            <p class="error-note">Note: To view your top songs, you need to authenticate with Spotify.</p>
                        </div>
                    `;
        } finally {
          loadButton.disabled = false;
        }
      }

      async function getLyrics(song) {
        try {
          const response = await fetch(
            `https://lrclib.net/api/get?artist_name=${song.artist}&track_name=${song.name}&album_name=${song.album}&duration=${song.duration}`,
          );
          const data = await response.json();

          if (!response.ok) {
            console.log("issue finding lyrics");
            throw new Error(data.error || "Failed to fetch lyrics");
          }
          console.log(data.trackName + ":\n\n" + data.plainLyrics);
        } catch (error) {
          console.error(error); // Catches HTTP errors and network errors
        }
      }

      function displayLyrics(lyrics) {
        const container = document.getElementById("top-songs-container");

        if (!lyrics) {
          container.getElementsByClassName("song-lyrics").item(0).textContent =
            "<p>test</p>";
        }
      }

      function displayTopSongs(songs) {
        const container = document.getElementById("top-songs-container");

        if (!songs || songs.length === 0) {
          container.innerHTML = '<p class="no-data">No top songs found.</p>';
          return;
        }

        const songsHTML = songs
          .map(
            (song) => `
                    <div class="song-item">
                        <div class="song-rank">#${song.rank}</div>
                        <div class="song-image">
                            <img src="${song.albumImage}" alt="${song.album}">
                        </div>
                        <div class="song-info">
                            <h3 class="song-name">${song.name}</h3>
                            <p class="song-artist">${song.artist}</p>
                            <p class="song-album">${song.album}</p>
                            <p class="song-length">${song.duration}</p>
                            <p class="song-lyrics">${displayLyrics(song)}</p>
                        </div>
                        <div class="song-actions">
                            ${song.previewUrl ? `<button class="btn-play" onclick="playPreview('${song.previewUrl}')">▶ Preview</button>` : ""}
                            <a href="${song.spotifyUrl}" target="_blank" class="btn-spotify">Open in Spotify</a>
                        </div>
                    </div>
                `,
          )
          .join("");

        container.innerHTML = `<div class="songs-list">${songsHTML}</div>`;
      }

      let currentAudio = null;
      function playPreview(url) {
        if (currentAudio) {
          currentAudio.pause();
        }
        currentAudio = new Audio(url);
        currentAudio.play();
      }

      document
        .getElementById("load-top-songs")
        .addEventListener("click", () => {
          const accessToken = prompt("Enter your Spotify access token:");

          if (accessToken) {
            fetchTopSongs(accessToken);
            // fetchLyricsMock();
          } else {
            alert("Access token is required to fetch your top songs.");
          }
        });
    </script>
  </body>
</html>
