<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotingfy Game</title>
    <script
      src="https://unpkg.com/htmx.org@1.9.10"
      integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container">
      <main>
        <section id="top-songs-section">
          <h2>Your Top Songs</h2>
          <button id="load-top-songs" class="btn-primary">
            Load Top Songs
          </button>
          <div id="top-songs-container"></div>
        </section>
        <section id="picross-section">
            <h2>Picrossify an album cover</h2>
            <button id="picrossify-random-image" class="picrossify-button">
                Picrossify an random album cover
            </button>
            <canvas id="album-canvas"></canvas>
        </section>
      </main>

      <footer>
        <p>Made with <span class="heart">♥</span></p>
      </footer>
    </div>
    <script src="picrossify.js" defer></script>
    <script>
      let songs = null;

      function picrossify(imageUrl) {
          // The resulting width and height of the 2D grid array of pixels

          const image = new Image();
          image.crossOrigin = "Anonymous";
          image.onload = function () {
              const canvas = document.getElementById('album-canvas');
              const ctx = canvas.getContext('2d');

              canvas.width = image.width;
              canvas.height = image.height;

              ctx.drawImage(image, 0, 0);

              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

              const pixelImage = new PixelImage(imageData, image.width, image.height);

              document.getElementById("picross-section").innerHTML = pixelImage.toHtml();
          }
          image.src = imageUrl;
      }
      async function fetchTopSongs(accessToken) {
        const container = document.getElementById("top-songs-container");
        const loadButton = document.getElementById("load-top-songs");

        // Show loading state
        container.innerHTML =
          '<p class="loading">Loading your top songs...</p>';
        loadButton.disabled = true;

        try {
          const response = await fetch(`/api/top-songs?token=${accessToken}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to fetch top songs");
          }

          songs = data.topSongs;
          displayTopSongs(data.topSongs);
        } catch (error) {
          container.innerHTML = `
                        <div class="error">
                            <p>❌ ${error.message}</p>
                            <p class="error-note">Note: To view your top songs, you need to authenticate with Spotify.</p>
                        </div>
                    `;
        } finally {
          loadButton.disabled = false;
        }
      }

      function displayTopSongs(songs) {
        const container = document.getElementById("top-songs-container");

        if (!songs || songs.length === 0) {
          container.innerHTML = '<p class="no-data">No top songs found.</p>';
          return;
        }

        const songsHTML = songs
          .map(
            (song) => `
                    <div class="song-item">
                        <div class="song-rank">#${song.rank}</div>
                        <div class="song-image">
                            <img src="${song.albumImage}" alt="${song.album}">
                        </div>
                        <div class="song-info">
                            <h3 class="song-name">${song.name}</h3>
                            <p class="song-artist">${song.artist}</p>
                            <p class="song-album">${song.album}</p>
                        </div>
                        <div class="song-actions">
                            ${song.previewUrl ? `<button class="btn-play" onclick="playPreview('${song.previewUrl}')">▶ Preview</button>` : ""}
                            <a href="${song.spotifyUrl}" target="_blank" class="btn-spotify">Open in Spotify</a>
                        </div>
                    </div>
                `,
          )
          .join("");

        container.innerHTML = `<div class="songs-list">${songsHTML}</div>`;
      }

      let currentAudio = null;
      function playPreview(url) {
        if (currentAudio) {
          currentAudio.pause();
        }
        currentAudio = new Audio(url);
        currentAudio.play();
      }

      document
        .getElementById("load-top-songs")
        .addEventListener("click", () => {
          const accessToken = prompt("Enter your Spotify access token:");

          if (accessToken) {
            fetchTopSongs(accessToken);
          } else {
            alert("Access token is required to fetch your top songs.");
          }
        });
      
      document
        .getElementById("picrossify-random-image")
        .addEventListener("click", () => {
          if (songs != null) {
            picrossify(songs[1].albumImage);
          }
        });
    </script>
  </body>
</html>
